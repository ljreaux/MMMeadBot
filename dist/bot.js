"use strict";var he=Object.create;var V=Object.defineProperty;var pe=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var ge=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var we=(e,n,o,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of fe(n))!be.call(e,t)&&t!==o&&V(e,t,{get:()=>n[t],enumerable:!(s=pe(n,t))||s.enumerable});return e};var h=(e,n,o)=>(o=e!=null?he(ge(e)):{},we(n||!e||!e.__esModule?V(o,"default",{value:e,enumerable:!0}):o,e));var f=require("discord.js"),ue=h(require("dotenv"));var P=h(require("mongoose")),j=h(require("dotenv"));j.default.config();var E=process.env.MONGO_URI,p=global.mongoose;async function ye(){if(!E)throw new Error("Please define the MONGODB_URI environment variable inside .env.local");if(p||(p=global.mongoose={conn:null,promise:null}),p.conn)return p.conn;if(!p.promise){let e={bufferCommands:!1};p.promise=P.default.connect(E,e).then(n=>(console.log("Db connected"),n))}try{p.conn=await p.promise}catch(e){throw p.promise=null,e}return p.conn}var D=ye;var v=h(require("mongoose")),ve=new v.default.Schema({command:{type:String,required:!0},response:{type:String,required:!0}}),O=v.default.models.Command||v.default.model("Command",ve);var C=h(require("mongoose")),Ce=new C.default.Schema({name:{type:String,required:!0},link:{type:String,required:!0}}),F=C.default.models.Recipe||C.default.model("Recipe",Ce);var A=async()=>await F.find(),G=async(e,n)=>{let o=await A(),[,s]=e.split(" ");if(!s)return;let t=s?.toLowerCase()||"",r=o.find(i=>i.name===t);if(r){n.channel.send(r.link);return}else if(s){n.channel.send(`The recipe ${s} is not a valid recipe command.`);return}};var Me=async()=>await O.find(),Y=async(e,n)=>{let t=(n?.guild?.roles.cache.filter(a=>a.name.toLowerCase().includes("meads")||a.name.toLowerCase()==="beginner")?.map(a=>a.name).sort((a,d)=>{let m=/^\d+/.test(a),g=/^\d+/.test(d);if(m&&g){let w=parseInt(a.match(/^\d+/)[0],10),$=parseInt(d.match(/^\d+/)[0],10);return w-$}else return m?1:g?-1:a.localeCompare(d)})||[]).reduce((a,d)=>`${a}
- ${d}`),r=await A(),i=await Me(),c=r.map(a=>a.name).reduce((a,d)=>`${a}
- ${d}`);for(let a of i){if(e.includes("!recipes ")||e.includes("!video "))return;e.startsWith(a.command)&&(e.toLowerCase().startsWith("!listranks")&&(a.response+=` 
- ${t}`),e==="!recipes"&&(a.response+=` 
- ${c}`),n.channel.send(a.response).catch(d=>console.error(d)))}let l=a=>{let d=a.map(m=>`${m.command}
`);return d.push("!abv"),d};if(e=="!list"){let a=`
**Available Bot Commands**
`,d=l(i),g=`${a}${d}`.replaceAll(",","");return n.channel.send(g).catch(w=>console.error(w))}};var xe=e=>-668.962+1262.45*e-776.43*e**2+182.94*e**3,ke=(e,n)=>{let o=-668.962+1262.45*e-776.43*e**2+182.94*e**3,s=-668.962+1262.45*n-776.43*n**2+182.94*n**3,t=.22+.001*o,r=(t*o+s)/(1+t),i=(o-r)/(2.0665-.010665*o),c=Math.round(i*(n/.794)*100)/100;return[Math.round(xe(n)+4.5*c),c]},q=(e,n)=>{let[,o,s]=e.split(" "),[t,r]=[Number(o),Number(s)||.996];if(isNaN(t)||isNaN(r)||t<r||t>1.22||r>1.22||t-r>.165)return n.channel.send("Please enter a valid number for OG and FG. Example: !abv 1.050 1.010");let[c,l]=ke(t,r),a=`An OG of ${t.toFixed(3)} and an FG of ${r.toFixed(3)} will make ${l}% ABV and ${c} delle units.`;return n.channel.send(a)};var L=require("discord.js");var M=h(require("mongoose")),Re=new M.default.Schema({command:{type:String,required:!0},response:{type:String,required:!0}}),x=M.default.models.video||M.default.model("video",Re);var Te=15,Se=["@everyone","@here"],y=e=>e.member?.permissionsIn(e.channel.id).has(L.PermissionsBitField.Flags.Administrator)||e.member?.permissionsIn(e.channel.id).has(L.PermissionsBitField.Flags.ModerateMembers),H=(e,n)=>{let o=n.includes("kick")?"kick":"ban";if(!y(e))return e.channel.send("Nice try, but you don't have the power");let[,s]=n.split(" ");if(!s)return e.channel.send(`You need to specify a user to ${o}.`);let t=e.mentions.users.first();return t?(o==="kick"?e.guild?.members.kick(t):e.guild?.members.ban(t),e.channel.send(`${t.tag} has been ${o}ed.`)):e.channel.send("User not found.")},W=e=>{let n=e.content.toLowerCase(),{member:o}=e;if(y(e))return!1;let s=(t,r)=>typeof t=="string"?r.includes(t):t.test(r);for(let t of Se){let r=s(t,n);if(r)return o?.timeout(Te*60*1e3),r}return!1},z=async(e,n)=>{if(!y(e))return e.channel.send("Nice try, but you don't have the power");let[,o,...s]=e.content.split(/[ ,]+/),t=o.slice(2,o.length-1),r=n(t),i=s.join(" ").trim();r&&r.send(i)},Ue=async e=>{let{command:n,response:o}=e,t=await new x({command:n,response:o}).save();return{command:t.command,response:t.response,id:t._id.toString()}},X=async e=>{if(!y(e))return e.channel.send("Nice try, but you don't have the power");let[,n]=e.content.split(" "),o=e.attachments.first();if(!o||!n)return e.channel.send("Please provide a video attachment and command name.");let s=o.url,t=`!video ${n}`;return await Ue({command:t,response:s})?e.channel.send(`${n} has been successfully added.`):e.channel.send("Something went wrong.")},K=e=>{if(y(e))return e.channel.send("Here are all the admin commands:\n1. ?kick `@user`\n2. ?ban `@user`\n3. ?registerVideo `video name` (attach video to message)\n4. To send a message from the bot, enter the following separated by spaces:\n  - `@MMMeadBot`\n  - `#channel-name`\n  - Your Message\n5. To add new commands visit the [admin dashboard.](https://mmmeadbot-admin-dashboard.vercel.app/)\n   ")};var _="?rank ",$e="1322772543962349670",Ae=["@everyone","Everyone","@Everyone","everyone","Administrator","Moderator","Mazer of the Week","Patreon Bot","Discord Mead Leader","MMM Patron","Mead Bot","Rhythm","Server Booster","EasyPoll","Live Countdown Bot","YouTube Member","technician","YouTube","YT Bot","UMM2024","UMM 2024 Purgatory Member","Commercial"],Le=e=>{for(let n of Ae)if(n.toLowerCase().includes(e.toLowerCase()))return!0;return!1},J=(e,n,o)=>{let s=o?.roles.cache.filter(c=>c.name.toLowerCase().includes("mead")||c.name.toLowerCase()==="beginner"),t=e.substring(_.length);if(t.toLowerCase().includes("every")||t.toLowerCase().includes("@"))return n.channel.send("Nice try. No ping for you.");if(Le(t))return n.channel.send(`You are in this discord server, but we do not grant you the rank of ${t}`);let r=n.guild?.roles.cache.find(c=>(t==="10"&&(t="10 "),t.length===1&&(t+=" "),c.name.toLowerCase()===t.toLowerCase()||c.name.toLowerCase().startsWith(t.toLowerCase())));if(!r)return n.channel.send(`The role ${t} is not a valid role.`);s?.forEach(c=>o?.roles.remove(c.id)),o?.roles.add(r.id);let i=n.guild?.channels.cache.get($e);return console.log(i),i?.send(`Congratulations to ${n.author.toString()} for graduating to the the rank ${r.name}!`).catch(c=>console.error(c)),n.channel.send(`You have been assigned to role "${r.name}"`).catch(c=>console.error(c))};var k=h(require("mongoose")),_e=new k.default.Schema({discordId:{type:String,required:!0},joinedAt:{type:Date,required:!0}}),R=k.default.models.User||k.default.model("User",_e);var Z=process.env.NEW_USER_ROLE||"",Ie=process.env.guildId||"";async function Q(e){let n=new Date,o=e.id,t=await new R({discordId:o,joinedAt:n}).save();return e.roles.add(Z),{discordId:t.discordId,joinedAt:t.joinedAt,id:t.id}}async function ee(){return await R.find({}).then(n=>n.map(o=>({_id:o._id.toString(),discordId:o.discordId,joinedAt:o.joinedAt})))}async function ne(e,n){if(e.length===0){console.log("No Users Found");return}let o=new Date().getTime(),t=1e3*60*60*24*7;e.forEach(r=>{o-r.joinedAt.getTime()>t&&(n.guilds.cache.get(Ie)?.members.cache.find(l=>l.id===r.discordId)?.roles.remove(Z),R.deleteOne({_id:r._id}).then(l=>console.log(l)),console.log(`Deleted user with discordId ${r.discordId}`))})}var U=h(require("node-cron"));var Ne=/belly.*pickle|pickle.*belly|pelly|bickle|sbp|s.b.p|belly.*cucumber|cucumber.*belly|tummy.*pickle|pickle.*tummy/i,I=async e=>{if(Ne.test(e.content))return e.channel.send(`${e.member?.user} You've been naughty. Stop that or go to jail. \u{1F46E} \u{1F693}`),await e.delete()};var Be=async()=>await x.find(),te=async(e,n)=>{let o=await Be(),[,s]=e.split(" ");if(!s)return;let t=s?.toLowerCase()||"",r=o.find(i=>i.command.includes(t));return r?n.channel.send(r.response):n.channel.send(`The video ${s} is not a valid video command.`)};var oe=["https://media.discordapp.net/attachments/568934729676488706/1250544810864148530/20240612_151713.jpg?ex=66f1cd1c&is=66f07b9c&hm=3d635d01f15e0522b2549b07d96f7c18e087a9bbb3d9d8782e1b170042eddb5c&=&format=webp&width=924&height=1232","https://media.discordapp.net/attachments/756322400890650635/1287570767675916341/20240922_202600.jpg?ex=66f20738&is=66f0b5b8&hm=a3997db24c2f3cdd6efdc18145b06ad095585b342ad7479ba5f298adeede61f0&=&format=webp&width=576&height=1232","https://cdn.discordapp.com/attachments/795860418056159244/1128472098604580995/20230605_113657.jpg?ex=66f1fd8a&is=66f0ac0a&hm=178a7995ee8333bf9908946a6dde17956a53c0987b506f86e5966a840b3624b2&","https://media.discordapp.net/attachments/568934729676488706/1250544810864148530/20240612_151713.jpg?ex=6722949c&is=6721431c&hm=39b52f65399074f44b7f64d7609fd602baaa5adef90cce23c9eed0525771e320&format=webp&width=924&height=1232&","https://media.discordapp.net/attachments/568934729676488706/1300924513919303843/20241029_214606.jpg?ex=67229bde&is=67214a5e&hm=b9ff518e9bab96d48245661c5c08a74134a8b1697bd4429d84a212dd9819450b&=&format=webp&width=1620&height=1216"],Ve=()=>oe[Math.floor(Math.random()*oe.length)],re=Ve;var Ee="https://cloudinary-dv10-api.vercel.app/api/list-media",Pe=async()=>{try{let e=await fetch(Ee);if(!e.ok)throw new Error(`Failed to fetch images: ${e.statusText}`);return(await e.json()).resources.filter(s=>s.secure_url).map(s=>s.secure_url)}catch(e){return console.error("Error fetching Cloudinary images:",e),[]}},se=async()=>{try{let e=await Pe();if(e.length)return e[Math.floor(Math.random()*e.length)];throw new Error("No images found in the Cloudinary folder.")}catch(e){return console.error(e),"No images available."}};var de=require("discord.js"),le=h(require("rss-parser"));var T=h(require("mongoose")),je=new T.default.Schema({video_id:{type:String,required:!0},created_at:{type:Date,required:!0}}),S=T.default.models.NewVideo||T.default.model("NewVideo",je);var De=new le.default,{YOUTUBE_XML_URL:ae,youtubeShenanigans:ie,guildId:ce}=process.env;async function N(e){try{if(!ae||!ie||!ce)throw new Error;let o=await(await e.guilds.fetch(ce)).channels.fetch(ie),s=await De.parseURL(ae),[t]=await S.find().lean(),r=t?.video_id||"",{id:i,title:c,link:l,author:a}=s.items[0];if(r!==i){await S.deleteMany({});let m=await(await S.create({created_at:new Date,video_id:i})).save();console.log("New video stored: ",m);let g=new de.EmbedBuilder({title:c,url:l,timestamp:Date.now(),image:{url:`https://img.youtube.com/vi/${i.slice(9)}/maxresdefault.jpg`},author:{name:a,iconURL:"https://yt3.googleusercontent.com/quhem18O3ZxjTxeHYD4B95wluihYXG5bmdUrY-dXD7-XrUwJUndGjpnys9H4lpA-W9Pzco51pkg=s160-c-k-c0x00ffffff-no-rj",url:"https://www.youtube.com/c/ManMadeMead/?sub_confirmation=1"},footer:{text:e.user?.tag||"",iconURL:e.user?.displayAvatarURL()||""}});await o?.send({embeds:[g]})}}catch(n){console.error("Error parsing RSS feed",n);return}}var b=require("discord.js"),{guildId:me}=process.env;async function B(e){let n="251250155960008704",o="434942205426401322",s=" https://res.cloudinary.com/devhg2clt/video/upload/v1734387048/1734386607_1734386559268_80482C2B5BB4131734386559_by9g3y.mp4";try{if(!me)throw new Error("Missing guildId in environment variables.");let t=await e.guilds.fetch(me),i=(await t.channels.fetch()).filter(m=>{if(m?.type!==b.ChannelType.GuildText)return!1;let g=m?.permissionsFor(t.members.me),w=m?.permissionsFor(n),$=m?.permissionsFor(o);return g?.has(b.PermissionsBitField.Flags.SendMessages)&&w?.has(b.PermissionsBitField.Flags.ViewChannel)&&$?.has(b.PermissionsBitField.Flags.ViewChannel)});if(console.log(i.map(m=>m?.name)),!i.size)throw new Error("No suitable text channels available.");let c=i.random(),l=Math.random(),d=`Hi, <@${l<.25?o:n}>`;l>.75&&(d+=s),await c.send(d)}catch(t){console.error("Error selecting or sending to a random channel",t);return}}ue.default.config();var{token:Oe,clientId:Fe,welcomeChannel:Ge="",botSpamChannel:Ye="",generalChannel:qe="",adminChannel:He=""}=process.env,u=new f.Client({intents:[f.GatewayIntentBits.Guilds,f.GatewayIntentBits.GuildMessages,f.GatewayIntentBits.MessageContent,f.GatewayIntentBits.GuildMembers,f.GatewayIntentBits.GuildPresences]});U.default.schedule("0 2 * * *",async()=>{let e=await ee();await ne(e,u)});U.default.schedule("*/5 * * * *",async()=>await N(u));U.default.schedule("0 * * * *",async()=>{Math.random()*30<=1&&B(u)});u.login(Oe);u.once(f.Events.ClientReady,async e=>{await D(),console.log(`Ready! Logged in as ${e.user.tag}`)});u.on("messageCreate",async e=>{if(e.author.bot)return;let n=u.channels.cache.get(He),o=l=>u.channels.cache.get(l),s=e.content,{member:t}=e,r=l=>s.toLowerCase().startsWith(l);r(`<@${Fe}>`)&&z(e,o);let i=W(e),c=`
<@&713811216979591282>
User ${t?.user} has been flagged for suspicious activity. They have been timed out for 15min. 
Suspicious content can be viewed here ${e.url}`;return i?n.send(c):r("?registervideo")?X(e):r("?kick")||r("?ban")?H(e,s):r("!adminlist")?K(e):(I(e),r("!recipes")&&G(s,e),r("!video")?te(s,e):r("!abv")?q(s,e):r("!flip")?e.channel.send("\u{1F6AB} No flips allowed! \u{1F6AB}"):r("!bakingsoda")?e.channel.send("Baking soda is not a mead ingredient!!"):r("!avocadohoney")?e.channel.send(re()):r("!dv10")?e.channel.send(await se()):r(_)?J(s,e,t):Y(s,e))});u.on("messageUpdate",(e,n)=>I(n));u.on("guildMemberAdd",e=>{Q(e);let n=u.channels.cache.get(Ge),o=`Welcome to the MMM Discord Server <@${e.user.id}>!

 Please head over to <#${Ye}> and run **?rank (rank)** to receive a rank.

Hop on into <#${qe}> channel and tell us what you're brewing or plan to brew!

Run **!recipes** to get a list of popular MMM recipes.

You can find a list of all commands by running **!list**`;n.send(o)});
