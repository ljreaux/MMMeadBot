"use strict";var le=Object.create;var I=Object.defineProperty;var me=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,he=Object.prototype.hasOwnProperty;var fe=(e,n,r,s)=>{if(n&&typeof n=="object"||typeof n=="function")for(let o of ue(n))!he.call(e,o)&&o!==r&&I(e,o,{get:()=>n[o],enumerable:!(s=me(n,o))||s.enumerable});return e};var l=(e,n,r)=>(r=e!=null?le(pe(e)):{},fe(n||!e||!e.__esModule?I(r,"default",{value:e,enumerable:!0}):r,e));var u=require("discord.js"),ie=l(require("dotenv"));var A=l(require("mongoose")),E=l(require("dotenv"));E.default.config();var _=process.env.MONGO_URI,m=global.mongoose;async function ge(){if(!_)throw new Error("Please define the MONGODB_URI environment variable inside .env.local");if(m||(m=global.mongoose={conn:null,promise:null}),m.conn)return m.conn;if(!m.promise){let e={bufferCommands:!1};m.promise=A.default.connect(_,e).then(n=>(console.log("Db connected"),n))}try{m.conn=await m.promise}catch(e){throw m.promise=null,e}return m.conn}var N=ge;var h=l(require("mongoose")),we=new h.default.Schema({command:{type:String,required:!0},response:{type:String,required:!0}}),V=h.default.models.Command||h.default.model("Command",we);var f=l(require("mongoose")),be=new f.default.Schema({name:{type:String,required:!0},link:{type:String,required:!0}}),B=f.default.models.Recipe||f.default.model("Recipe",be);var k=async()=>await B.find(),j=async(e,n)=>{let r=await k(),[,s]=e.split(" ");if(!s)return;let o=s?.toLowerCase()||"",t=r.find(a=>a.name===o);if(t){n.channel.send(t.link);return}else if(s){n.channel.send(`The recipe ${s} is not a valid recipe command.`);return}};var ye=["Beginner","10 Meads","20 Meads","25 Meads","30 Meads","40 Meads","50 Meads","75 Meads","100 Meads"],Me=ye.reduce((e,n)=>`${e}
- ${n}`),ve=async()=>await V.find(),P=async(e,n)=>{let r=await k(),s=await ve(),o=r.map(a=>a.name).reduce((a,i)=>`${a}
- ${i}`);for(let a of s){if(e.includes("!recipes ")||e.includes("!video "))return;e.startsWith(a.command)&&(e.toLowerCase().startsWith("!listranks")&&(a.response+=` 
- ${Me}`),e==="!recipes"&&(a.response+=` 
- ${o}`),n.channel.send(a.response).catch(i=>console.error(i)))}let t=a=>{let i=a.map(c=>`${c.command}
`);return i.push("!abv"),i};if(e=="!list"){let a=`
**Available Bot Commands**
`,i=t(s),p=`${a}${i}`.replaceAll(",","");return n.channel.send(p).catch(L=>console.error(L))}};var Ce=e=>-668.962+1262.45*e-776.43*e**2+182.94*e**3,xe=(e,n)=>{let r=-668.962+1262.45*e-776.43*e**2+182.94*e**3,s=-668.962+1262.45*n-776.43*n**2+182.94*n**3,o=.22+.001*r,t=(o*r+s)/(1+o),a=(r-t)/(2.0665-.010665*r),i=Math.round(a*(n/.794)*100)/100;return[Math.round(Ce(n)+4.5*i),i]},D=(e,n)=>{let[,r,s]=e.split(" "),[o,t]=[Number(r),Number(s)||.996];if(isNaN(o)||isNaN(t)||o<t||o>1.22||t>1.22||o-t>.165)return n.channel.send("Please enter a valid number for OG and FG. Example: !abv 1.050 1.010");let[i,c]=xe(o,t),p=`An OG of ${o.toFixed(3)} and an FG of ${t.toFixed(3)} will make ${c}% ABV and ${i} delle units.`;return n.channel.send(p)};var R=require("discord.js");var g=l(require("mongoose")),ke=new g.default.Schema({command:{type:String,required:!0},response:{type:String,required:!0}}),w=g.default.models.video||g.default.model("video",ke);var Re=15,Se=["@everyone","@here"],b=e=>e.member?.permissionsIn(e.channel.id).has(R.PermissionsBitField.Flags.Administrator)||e.member?.permissionsIn(e.channel.id).has(R.PermissionsBitField.Flags.ModerateMembers),O=(e,n)=>{let r=n.includes("kick")?"kick":"ban";if(!b(e))return e.channel.send("Nice try, but you don't have the power");let[,s]=n.split(" ");if(!s)return e.channel.send(`You need to specify a user to ${r}.`);let o=e.mentions.users.first();return o?(r==="kick"?e.guild?.members.kick(o):e.guild?.members.ban(o),e.channel.send(`${o.tag} has been ${r}ed.`)):e.channel.send("User not found.")},G=e=>{let n=e.content.toLowerCase(),{member:r}=e;if(b(e))return!1;let s=(o,t)=>typeof o=="string"?t.includes(o):o.test(t);for(let o of Se){let t=s(o,n);if(t)return r?.timeout(Re*60*1e3),t}return!1},q=async(e,n)=>{if(!b(e))return e.channel.send("Nice try, but you don't have the power");let[,r,...s]=e.content.split(/[ ,]+/),o=r.slice(2,r.length-1),t=n(o),a=s.join(" ").trim();t&&t.send(a)},Te=async e=>{let{command:n,response:r}=e,o=await new w({command:n,response:r}).save();return{command:o.command,response:o.response,id:o._id.toString()}},Y=async e=>{if(!b(e))return e.channel.send("Nice try, but you don't have the power");let[,n]=e.content.split(" "),r=e.attachments.first();if(!r||!n)return e.channel.send("Please provide a video attachment and command name.");let s=r.url,o=`!video ${n}`;return await Te({command:o,response:s})?e.channel.send(`${n} has been successfully added.`):e.channel.send("Something went wrong.")};var S="?rank ",Ue=["@everyone","Everyone","@Everyone","everyone","Administrator","Moderator","Mazer of the Week","Patreon Bot","Discord Mead Leader","MMM Patron","Mead Bot","Rhythm","Server Booster","EasyPoll","Live Countdown Bot","YouTube Member","technician","YouTube","YT Bot","UMM2024","UMM 2024 Purgatory Member","Commercial"],$e=e=>{for(let n of Ue)if(n.toLowerCase().includes(e.toLowerCase()))return!0;return!1},F=(e,n,r)=>{let s=r?.roles.cache.filter(a=>a.name.toLowerCase().includes("mead")||a.name.toLowerCase()==="beginner"),o=e.substring(S.length);if(o.toLowerCase().includes("every")||o.toLowerCase().includes("@"))return n.channel.send("Nice try. No ping for you.");if($e(o))return n.channel.send(`You are in this discord server, but we do not grant you the rank of ${o}`);let t=n.guild?.roles.cache.find(a=>(o==="10"&&(o="10 "),o.length===1&&(o+=" "),a.name.toLowerCase()===o.toLowerCase()||a.name.toLowerCase().startsWith(o.toLowerCase())));return t?(s?.forEach(a=>r?.roles.remove(a.id)),r?.roles.add(t.id),n.channel.send(`You have been assigned to role "${t.name}"`).catch(a=>console.error(a))):n.channel.send(`The role ${o} is not a valid role.`)};var y=l(require("mongoose")),Le=new y.default.Schema({discordId:{type:String,required:!0},joinedAt:{type:Date,required:!0}}),M=y.default.models.User||y.default.model("User",Le);var W=process.env.NEW_USER_ROLE||"",Ie=process.env.guildId||"";async function H(e){let n=new Date,r=e.id,o=await new M({discordId:r,joinedAt:n}).save();return e.roles.add(W),{discordId:o.discordId,joinedAt:o.joinedAt,id:o.id}}async function z(){return await M.find({}).then(n=>n.map(r=>({_id:r._id.toString(),discordId:r.discordId,joinedAt:r.joinedAt})))}async function X(e,n){if(e.length===0){console.log("No Users Found");return}let r=new Date().getTime(),o=1e3*60*60*24*7;e.forEach(t=>{r-t.joinedAt.getTime()>o&&(n.guilds.cache.get(Ie)?.members.cache.find(c=>c.id===t.discordId)?.roles.remove(W),M.deleteOne({_id:t._id}).then(c=>console.log(c)),console.log(`Deleted user with discordId ${t.discordId}`))})}var x=l(require("node-cron"));var _e=/belly.*pickle|pickle.*belly|pelly|bickle|sbp|s.b.p|belly.*cucumber|cucumber.*belly|tummy.*pickle|pickle.*tummy/i,T=async e=>{if(_e.test(e.content))return e.channel.send(`${e.member?.user} You've been naughty. Stop that or go to jail. \u{1F46E} \u{1F693}`),await e.delete()};var Ae=async()=>await w.find(),J=async(e,n)=>{let r=await Ae(),[,s]=e.split(" ");if(!s)return;let o=s?.toLowerCase()||"",t=r.find(a=>a.command.includes(o));return t?n.channel.send(t.response):n.channel.send(`The video ${s} is not a valid video command.`)};var K=["https://media.discordapp.net/attachments/568934729676488706/1250544810864148530/20240612_151713.jpg?ex=66f1cd1c&is=66f07b9c&hm=3d635d01f15e0522b2549b07d96f7c18e087a9bbb3d9d8782e1b170042eddb5c&=&format=webp&width=924&height=1232","https://media.discordapp.net/attachments/756322400890650635/1287570767675916341/20240922_202600.jpg?ex=66f20738&is=66f0b5b8&hm=a3997db24c2f3cdd6efdc18145b06ad095585b342ad7479ba5f298adeede61f0&=&format=webp&width=576&height=1232","https://cdn.discordapp.com/attachments/795860418056159244/1128472098604580995/20230605_113657.jpg?ex=66f1fd8a&is=66f0ac0a&hm=178a7995ee8333bf9908946a6dde17956a53c0987b506f86e5966a840b3624b2&","https://media.discordapp.net/attachments/568934729676488706/1250544810864148530/20240612_151713.jpg?ex=6722949c&is=6721431c&hm=39b52f65399074f44b7f64d7609fd602baaa5adef90cce23c9eed0525771e320&format=webp&width=924&height=1232&","https://media.discordapp.net/attachments/568934729676488706/1300924513919303843/20241029_214606.jpg?ex=67229bde&is=67214a5e&hm=b9ff518e9bab96d48245661c5c08a74134a8b1697bd4429d84a212dd9819450b&=&format=webp&width=1620&height=1216"],Ee=()=>K[Math.floor(Math.random()*K.length)],Z=Ee;var Ne="https://cloudinary-dv10-api.vercel.app/api/list-media",Ve=async()=>{try{let e=await fetch(Ne);if(!e.ok)throw new Error(`Failed to fetch images: ${e.statusText}`);return(await e.json()).resources.filter(s=>s.secure_url).map(s=>s.secure_url)}catch(e){return console.error("Error fetching Cloudinary images:",e),[]}},Q=async()=>{try{let e=await Ve();if(e.length)return e[Math.floor(Math.random()*e.length)];throw new Error("No images found in the Cloudinary folder.")}catch(e){return console.error(e),"No images available."}};var te=require("discord.js"),re=l(require("rss-parser"));var v=l(require("mongoose")),Be=new v.default.Schema({video_id:{type:String,required:!0},created_at:{type:Date,required:!0}}),C=v.default.models.NewVideo||v.default.model("NewVideo",Be);var je=new re.default,{YOUTUBE_XML_URL:ee,youtubeShenanigans:ne,guildId:oe}=process.env;async function U(e){try{if(!ee||!ne||!oe)throw new Error;let r=await(await e.guilds.fetch(oe)).channels.fetch(ne),s=await je.parseURL(ee),[o]=await C.find().lean(),t=o?.video_id||"",{id:a,title:i,link:c,author:p}=s.items[0];if(t!==a){await C.deleteMany({});let ce=await(await C.create({created_at:new Date,video_id:a})).save();console.log("New video stored: ",ce);let de=new te.EmbedBuilder({title:i,url:c,timestamp:Date.now(),image:{url:`https://img.youtube.com/vi/${a.slice(9)}/maxresdefault.jpg`},author:{name:p,iconURL:"https://yt3.googleusercontent.com/quhem18O3ZxjTxeHYD4B95wluihYXG5bmdUrY-dXD7-XrUwJUndGjpnys9H4lpA-W9Pzco51pkg=s160-c-k-c0x00ffffff-no-rj",url:"https://www.youtube.com/c/ManMadeMead/?sub_confirmation=1"},footer:{text:e.user?.tag||"",iconURL:e.user?.displayAvatarURL()||""}});await r?.send({embeds:[de]})}}catch(n){console.error("Error parsing RSS feed",n);return}}var ae=require("discord.js"),{guildId:se}=process.env;async function $(e){let n="251250155960008704",r="434942205426401322";try{if(!se)throw new Error("Missing guildId in environment variables.");let s=await e.guilds.fetch(se),t=(await s.channels.fetch()).filter(c=>c?.type===ae.ChannelType.GuildText&&c?.permissionsFor(s.members.me)?.has("SendMessages"));if(console.log(t.map(c=>c?.name)),!t.size)throw new Error("No suitable text channels available.");let a=t.random(),i=Math.random()<.25?r:n;await a.send(`Hi, <@${i}>`)}catch(s){console.error("Error selecting or sending to a random channel",s);return}}ie.default.config();var{token:Pe,clientId:De,welcomeChannel:Oe="",botSpamChannel:Ge="",generalChannel:qe="",adminChannel:Ye=""}=process.env,d=new u.Client({intents:[u.GatewayIntentBits.Guilds,u.GatewayIntentBits.GuildMessages,u.GatewayIntentBits.MessageContent,u.GatewayIntentBits.GuildMembers,u.GatewayIntentBits.GuildPresences]});x.default.schedule("0 2 * * *",async()=>{let e=await z();await X(e,d)});x.default.schedule("*/5 * * * *",async()=>await U(d));x.default.schedule("0 * * * *",async()=>{Math.random()*10<=1&&$(d)});d.login(Pe);d.once(u.Events.ClientReady,async e=>{await N(),console.log(`Ready! Logged in as ${e.user.tag}`)});d.on("messageCreate",async e=>{if(e.author.bot)return;let n=d.channels.cache.get(Ye),r=c=>d.channels.cache.get(c),s=e.content,{member:o}=e,t=c=>s.toLowerCase().startsWith(c);t(`<@${De}>`)&&q(e,r);let a=G(e),i=`
<@&713811216979591282>
User ${o?.user} has been flagged for suspicious activity. They have been timed out for 15min. 
Suspicious content can be viewed here ${e.url}`;return a?n.send(i):t("?registervideo")?Y(e):t("?kick")||t("?ban")?O(e,s):(T(e),t("!recipes")&&j(s,e),t("!video")?J(s,e):t("!abv")?D(s,e):t("!flip")?e.channel.send("\u{1F6AB} No flips allowed! \u{1F6AB}"):t("!bakingsoda")?e.channel.send("Baking soda is not a mead ingredient!!"):t("!avocadohoney")?e.channel.send(Z()):t("!dv10")?e.channel.send(await Q()):t(S)?F(s,e,o):P(s,e))});d.on("messageUpdate",(e,n)=>T(n));d.on("guildMemberAdd",e=>{H(e);let n=d.channels.cache.get(Oe),r=`Welcome to the MMM Discord Server <@${e.user.id}>!

 Please head over to <#${Ge}> and run **?rank (rank)** to receive a rank and join your mini mead making community.

Hop on into <#${qe}> channel and tell us what you're brewing or plan to brew!

Run **!recipes** to get a list of popular MMM recipes.

You can find a list of all commands by running **!list**`;n.send(r)});
